@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<h3>User Chat</h3>

<div id="chat-container" style="border:1px solid #ccc; padding:10px; height:300px; overflow:auto;">
    @foreach (var m in messages)
    {
        <p>
            <b>@(m.Role == "user" ? "You" : "Bot"):</b>
            @m.Content
        </p>
    }

    @if (isTyping)
    {
        <p><i>Bot is typing...</i></p>
    }
</div>

<br />

<input type="text"
       @bind="message"
       placeholder="Ask something..."
       style="width:300px; padding:6px;" />

<button @onclick="Send">Send</button>

<button @onclick="ToggleHistory" style="margin-left: 10px;">
    @(showPreviousChat ? "Hide Previous Chat" : "Show Previous Chat")
</button>

@using System.IO
@code {
    string sessionId = "ui-session";
    string message = "";
    bool isTyping = false;
    bool showPreviousChat = false;

    List<ChatMessage> messages = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("scrollToBottom", "chat-container");
    }

    protected override async Task OnInitializedAsync()
    {
        // Don't load history automatically
    }

    async Task ToggleHistory()
    {
        showPreviousChat = !showPreviousChat;
        if (showPreviousChat)
        {
            await LoadHistory();
        }
        else
        {
            // Optional: clear messages if hiding? 
            // Better to just keep current session. 
            // For now, let's reload history to be safe when showing.
        }
    }

    async Task Send()
    {
        if (string.IsNullOrWhiteSpace(message))
            return;

        messages.Add(new ChatMessage(sessionId, "user", message, Now()));
        var userMessage = message;
        message = "";

        // Placeholder for bot response
        var botMessage = new ChatMessage(sessionId, "assistant", "", Now());
        messages.Add(botMessage);

        isTyping = true;

        var request = new HttpRequestMessage(HttpMethod.Post, "/chat/stream")
        {
            Content = JsonContent.Create(new { sessionId, message = userMessage })
        };

        using var response = await Http.SendAsync(request, HttpCompletionOption.ResponseHeadersRead);
        using var stream = await response.Content.ReadAsStreamAsync();
        using var reader = new StreamReader(stream);

        while (!reader.EndOfStream)
        {
            var chunk = await reader.ReadLineAsync();
            // In case of empty lines or keep-alives
            if (chunk != null)
            {
                botMessage.Content += chunk + " "; 
                StateHasChanged();
            }
        }

        isTyping = false;
        // Do NOT reload history here, strictly keep the current view
        // await LoadHistory(); 
    }

    async Task LoadHistory()
    {
        messages = await Http.GetFromJsonAsync<List<ChatMessage>>(
            $"/chat/history/{sessionId}") ?? new();
    }

    long Now() => DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();

    // Mutable class for streaming updates
    public class ChatMessage
    {
        public string SessionId { get; set; }
        public string Role { get; set; }
        public string Content { get; set; }
        public long Timestamp { get; set; }

        public ChatMessage() { }

        public ChatMessage(string sessionId, string role, string content, long timestamp)
        {
            SessionId = sessionId;
            Role = role;
            Content = content;
            Timestamp = timestamp;
        }
    }

    record ChatResponse(string answer, string intent);
}
