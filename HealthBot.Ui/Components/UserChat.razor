@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<h3>User Chat</h3>

<div id="chat-container" style="border:1px solid #ccc; padding:10px; height:300px; overflow:auto;">
    @foreach (var m in messages)
    {
        <p>
            <b>@(m.Role == "user" ? "You" : "Bot"):</b>
            @m.Content
        </p>
    }

    @if (isTyping)
    {
        <p><i>Bot is typing...</i></p>
    }
</div>

<br />

<input type="text"
       @bind="message"
       placeholder="Ask something..."
       style="width:300px; padding:6px;" />

<button @onclick="Send">Send</button>

@code {
    string sessionId = "ui-session";
    string message = "";
    bool isTyping = false;

    List<ChatMessage> messages = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("scrollToBottom", "chat-container");
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadHistory();
    }

    async Task Send()
    {
        if (string.IsNullOrWhiteSpace(message))
            return;

        // Show user message immediately
        messages.Add(new ChatMessage(sessionId, "user", message, Now()));
        var userMessage = message;
        message = "";

        // SHOW typing indicator
        isTyping = true;

        var res = await Http.PostAsJsonAsync("/chat", new
        {
            sessionId,
            message = userMessage
        });

        var data = await res.Content.ReadFromJsonAsync<ChatResponse>();

        // HIDE typing indicator
        isTyping = false;

        // Show bot response
        messages.Add(new ChatMessage(
            sessionId,
            "assistant",
            data?.answer ?? "No response",
            Now()
        ));

        await LoadHistory();
    }

    long Now() => DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();

    async Task LoadHistory()
    {
        messages = await Http.GetFromJsonAsync<List<ChatMessage>>(
            $"/chat/history/{sessionId}") ?? new();
    }

    record ChatMessage(string SessionId, string Role, string Content, long Timestamp);
    record ChatResponse(string answer, string intent);
}
